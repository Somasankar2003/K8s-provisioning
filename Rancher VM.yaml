---
- name: Create OpenStack VMs (boot from volume) and auto-register to Rancher
  hosts: localhost
  connection: local
  gather_facts: no

  vars:
    ###########################################################################
    # Rancher
    ###########################################################################
    rancher_url: "https://10.68.0.173"
    rancher_token: "token-rqh8z:njslgl8dqqv6wp65dlm8ff9mq29ztghffxkqrvzbcst885r2sl2gnw"
    cluster_name: "{{ cluster_name }}"

    ###########################################################################
    # Survey
    ###########################################################################
    vm_count: "{{ vm_count | int }}"
    node_roles: "{{ node_roles }}"
    vm_net: "{{ vm_net }}"
    vm_flavor: "{{ vm_flavor }}"
    vm_security_groups: "{{ vm_security_groups }}"
    vm_names_list: "{{ vm_name_prefix.split(',') | map('trim') | list }}"

    ###########################################################################
    # Storage
    ###########################################################################
    root_volume_size: 40
    volume_type: ""        # optional, leave empty if not needed

    ###########################################################################
    # VM
    ###########################################################################
    vm_image: "0f92312d-bbcf-4c5a-964a-cfa4898940bd"
    vm_keypair: "k8"

    ###########################################################################
    # OpenStack Auth
    ###########################################################################
    os_auth_url: "https://keystone-public-openstack.apps.pgrhoso.dccloud.com"
    os_project_name: "admin"
    os_project_domain_id: "default"
    os_username: "admin"
    os_user_domain_name: "Default"
    os_password: "stl@123"
    os_region_name: "regionOne"
    os_interface: "public"
    os_identity_api_version: "3"

  tasks:
  ###########################################################################
  # VALIDATION
  ###########################################################################
  - assert:
      that:
        - vm_names_list | length == vm_count
      fail_msg: "vm_count must match VM names"

  - set_fact:
      parsed_roles: "{{ node_roles.split(',') | map('trim') | list }}"

  - assert:
      that:
        - parsed_roles | length == vm_count
        - "'etcd' in parsed_roles"
        - "'controlplane' in parsed_roles"
        - "'worker' in parsed_roles"
      fail_msg: "Roles must include etcd, controlplane, worker"

  - set_fact:
      vm_role_map: "{{ vm_names_list | zip(parsed_roles) | list }}"

  ###########################################################################
  # RANCHER
  ###########################################################################
  - name: Get cluster ID
    uri:
      url: "{{ rancher_url }}/v3/clusters?name={{ cluster_name }}"
      method: GET
      headers:
        Authorization: "Bearer {{ rancher_token }}"
      validate_certs: no
    register: cluster_info

  - set_fact:
      cluster_id: "{{ cluster_info.json.data[0].id }}"

  - name: Get join command
    uri:
      url: "{{ rancher_url }}/v3/clusterRegistrationTokens?clusterId={{ cluster_id }}"
      method: GET
      headers:
        Authorization: "Bearer {{ rancher_token }}"
      validate_certs: no
    register: reg_info
    until: reg_info.json.data[0].nodeCommand is defined
    retries: 20
    delay: 5

  - set_fact:
      node_command: "{{ reg_info.json.data[0].nodeCommand | replace('curl ', 'curl -k ') }}"

  ###########################################################################
  # CLOUD-INIT
  ###########################################################################
  - name: Create cloud-init
    copy:
      dest: "/tmp/cloud-init-{{ item.0 }}.yml"
      content: |
        #cloud-config
        package_update: true
        packages:
          - curl
          - jq
          - nfs-common

        runcmd:
          - swapoff -a
          - sed -i '/ swap / s/^/#/' /etc/fstab
          - modprobe overlay
          - modprobe br_netfilter
          - |
            cat <<EOF >/etc/sysctl.d/99-kubernetes.conf
            net.bridge.bridge-nf-call-iptables=1
            net.bridge.bridge-nf-call-ip6tables=1
            net.ipv4.ip_forward=1
            EOF
          - sysctl --system
          - sleep 60
          - |
            CMD="{{ node_command }}"
            {% if 'etcd' in item.1 %}CMD="$CMD --etcd"{% endif %}
            {% if 'controlplane' in item.1 %}CMD="$CMD --controlplane"{% endif %}
            {% if 'worker' in item.1 %}CMD="$CMD --worker"{% endif %}
            CMD="$CMD --node-name {{ item.0 }}"
            echo "$CMD" > /root/join.sh
            chmod +x /root/join.sh
            /root/join.sh
    loop: "{{ vm_role_map }}"

  ###########################################################################
  # CREATE VOLUMES
  ###########################################################################
  - name: Create root volumes
    openstack.cloud.volume:
      state: present
      name: "{{ item.0 }}-root"
      size: "{{ root_volume_size }}"
      image: "{{ vm_image }}"
      volume_type: "{{ volume_type | default(omit) }}"
      wait: yes
    environment:
      OS_AUTH_URL: "{{ os_auth_url }}"
      OS_PROJECT_NAME: "{{ os_project_name }}"
      OS_PROJECT_DOMAIN_ID: "{{ os_project_domain_id }}"
      OS_USERNAME: "{{ os_username }}"
      OS_USER_DOMAIN_NAME: "{{ os_user_domain_name }}"
      OS_PASSWORD: "{{ os_password }}"
      OS_REGION_NAME: "{{ os_region_name }}"
      OS_INTERFACE: "{{ os_interface }}"
      OS_IDENTITY_API_VERSION: "{{ os_identity_api_version }}"
    loop: "{{ vm_role_map }}"

  ###########################################################################
  # CREATE SERVERS (SAFE METHOD)
  ###########################################################################
  - name: Create VMs (boot from volume)
    openstack.cloud.server:
      state: present
      name: "{{ item.0 }}"
      flavor: "{{ vm_flavor }}"
      key_name: "{{ vm_keypair }}"
      network: "{{ vm_net }}"
      security_groups: "{{ vm_security_groups.split(',') }}"
      boot_volume: "{{ item.0 }}-root"
      terminate_volume: true
      userdata: "{{ lookup('file', '/tmp/cloud-init-' + item.0 + '.yml') }}"
      wait: yes
      timeout: 900
      validate_certs: false
    environment:
      OS_AUTH_URL: "{{ os_auth_url }}"
      OS_PROJECT_NAME: "{{ os_project_name }}"
      OS_PROJECT_DOMAIN_ID: "{{ os_project_domain_id }}"
      OS_USERNAME: "{{ os_username }}"
      OS_USER_DOMAIN_NAME: "{{ os_user_domain_name }}"
      OS_PASSWORD: "{{ os_password }}"
      OS_REGION_NAME: "{{ os_region_name }}"
      OS_INTERFACE: "{{ os_interface }}"
      OS_IDENTITY_API_VERSION: "{{ os_identity_api_version }}"
    loop: "{{ vm_role_map }}"

  ###########################################################################
  # CLEANUP
  ###########################################################################
  - file:
      path: "/tmp/cloud-init-{{ item }}.yml"
      state: absent
    loop: "{{ vm_names_list }}"
